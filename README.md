# Population Branch Statistic (PBS) Analysis Pipeline

## Overview
This R-based computational pipeline calculates Population Branch Statistics (PBS) from pairwise FST data to identify selection signatures in target populations. The PBS statistic measures the extent of allele frequency change in a target population relative to two reference populations, providing insights into recent positive selection.

## Key Features
- **Automated PBS Calculation**: Computes PBS values using the formula: `PBS = (T₁ + T₂ - T₃)/2`, where `Tᵢ = -log(1 - FSTᵢ)`
- **Multiple Experimental Designs**: Supports simultaneous analysis of multiple population trios (target, reference1, reference2)
- **Comprehensive Results**: Generates complete PBS values, top percentile signals, and intersections between designs
- **Standardized Output**: Produces both CSV and BED formats for downstream analysis and visualization
- **Robust Data Handling**: Implements FST value boundary checks and missing data management
- **Reproducible Analysis**: Includes summary reports and standardized file naming

## Prerequisites

### Software Requirements
- R (≥ 4.0.0)
- Required R packages:
  - `dplyr`
  - `data.table`
  - `tidyr`
  - `purrr`
  - `ggplot2` (optional, for visualization)

Install required packages using:
```r
install.packages(c("dplyr", "data.table", "tidyr", "purrr", "ggplot2"))
```

### Input Data Requirements
The pipeline requires pairwise FST files generated by **PLINK's `--fst`** function with sliding window analysis. Specifically:

1. **File Generation Command** (example):
   ```bash
   plink --bfile [population_pair] --fst window --window-size [size] --window-step [step] --out [output_prefix]
   ```

2. **Required File Format**:
   - **File naming convention**: `[PopA]_vs_[PopB].windowed.weir.fst`
   - **Expected columns** (6 columns, tab-separated):
     ```
     CHROM   BIN_START   BIN_END N_VARIANTS      MEAN_FST       WEIGHTED_FST
     ```

3. **File Organization**:
   ```
   Working Directory/
   ├── PopulationA_vs_PopulationB.windowed.weir.fst
   ├── PopulationA_vs_PopulationC.windowed.weir.fst
   └── PopulationB_vs_PopulationC.windowed.weir.fst
   ```

## Configuration

### Step 1: Modify Script Parameters
Open the R script and adjust the following parameters in the configuration section:

```r
# 1. Set working directory (line 21)
setwd("PATH_TO_YOUR_FST_FILES")

# 2. Define experimental designs (lines 31-36)
designs <- list(
  "Target_Ref1_Ref2" = c("Target", "Reference1", "Reference2"),
  "Jino_Tibetan_Blang" = c("Jino", "Tibetan", "Blang")
  # Add more designs as needed
)

# 3. Adjust file naming pattern if different (line 39)
file_pattern <- "_vs_"  # Modify if your files use different separators

# 4. Set analysis parameters (lines 42-43)
top_percent <- 0.01     # Top 1% of PBS values
min_fst <- 1e-6         # Minimum FST value for numerical stability
```

### Step 2: Verify Population Names
Ensure that population names in the `designs` list exactly match those in your FST filenames (excluding the `_vs_` separator and suffixes).

## Usage

### Basic Execution
Run the entire analysis pipeline with default parameters:
```r
source("PBS_analysis_script.R")
```

The script will:
1. Load all FST files from the working directory
2. Calculate PBS for each defined population trio
3. Extract top percentile signals for each design
4. Compute intersections between designs (if multiple designs specified)
5. Generate output files and summary reports

### Custom Analysis
For advanced users, individual functions can be called separately:

```r
# Load FST data
fst_data <- load_all_fst_data(data_dir = "your_directory")

# Calculate PBS for a specific trio
pbs_results <- calculate_PBS(fst_data, "Target", "Ref1", "Ref2")

# Extract top 1% signals
top_signals <- extract_top_percent(pbs_results, percent = 0.01)
```

## Output Files

The pipeline generates the following files in the `PBS_analysis_results/` directory:

### 1. Complete PBS Results
- **`PBS_full_[DesignName].csv`**: Complete PBS values for all genomic windows
  - Columns: `chr, start, end, fst_TR1, fst_TR2, fst_R1R2, T_TR1, T_TR2, T_R1R2, PBS, design`
  - Contains all intermediate calculations for transparency

### 2. Top Percentile Results
- **By PBS value**: `PBS_top_[X]percent_[DesignName]_byPBS.csv`
- **By genomic position**: `PBS_top_[X]percent_[DesignName]_byPosition.csv`
- **BED format**: `PBS_top_[X]percent_[DesignName]_byPBS.bed` (for genome browsers)

### 3. Intersection Results (multiple designs only)
- **`PBS_intersection_top[X]percent_byPBS.csv`**: Genomic regions identified in all designs
- **`PBS_intersection_top[X]percent_byPosition.csv`**: Same data, position-sorted

### 4. Summary Reports
- **`PBS_analysis_summary.txt`**: Comprehensive statistics including:
  - Number of windows analyzed per design
  - PBS mean, median, and maximum values
  - Top percentile signal counts
  - Intersection statistics

## Output File Structure

### PBS Results CSV Format
```
chr    start     end       fst_TR1   fst_TR2   fst_R1R2  T_TR1     T_TR2     T_R1R2    PBS       design
1      1000000   1100000   0.0234    0.0156    0.0012    0.0237    0.0157    0.0012    0.0191    Jino_Tibetan_Blang
1      1100000   1200000   0.0189    0.0123    0.0009    0.0191    0.0124    0.0009    0.0153    Jino_Tibetan_Blang
...
```

### BED Format (for genome browsers)
```
chr    start_0based   end   site_1
chr1   999999         1100000   site_1
chr1   1099999        1200000   site_2
...
```

## Interpretation of Results

### PBS Values
- **High PBS values** indicate strong selection signals in the target population
- **Statistical threshold**: The top 1% (configurable) of PBS values represent the strongest candidate regions
- **Biological interpretation**: Regions with elevated PBS values may contain genes under recent positive selection

### Intersection Analysis
- Regions identified across multiple experimental designs represent robust selection signals
- Use intersection results for downstream validation and functional annotation

## Troubleshooting

### Common Issues

1. **"No FST files found" error**
   - Verify file naming follows `[PopA]_vs_[PopB].windowed.weir.fst` format
   - Check working directory path in script configuration

2. **Missing population pair data**
   - Ensure all required pairwise FST files exist (target-ref1, target-ref2, ref1-ref2)
   - Confirm population names match exactly between designs and filenames

3. **Negative or extreme PBS values**
   - The script automatically truncates FST values to (0, 1-ε) range
   - Check input FST files for anomalies or calculation errors

### Debug Mode
Uncomment debugging sections in the script for verbose output:
```r
# In read_fst_file() function:
cat("pops extracted:", pops, "\n")
cat("pair generated:", standardize_pair(pops[1], pops[2]), "\n")
```

## Customization Options

### 1. Adding New Designs
Edit the `designs` list to include additional population trios:
```r
designs <- list(
  "Design1" = c("Target1", "Ref1", "Ref2"),
  "Design2" = c("Target2", "Ref3", "Ref4"),
  "YourDesign" = c("YourTarget", "YourRef1", "YourRef2")
)
```

### 2. Adjusting Statistical Thresholds
Modify analysis parameters:
```r
top_percent <- 0.05     # Top 5% instead of 1%
min_fst <- 1e-5         # Adjust for different FST ranges
```

### 3. Visualization (Optional)
Uncomment the visualization section (lines 492-530) to generate distribution plots:
```r
# Remove commenting from lines 511-518:
if (!is.null(analysis_results$pbs_results)) {
  cat("\nGenerating visualizations...\n")
  for (design_name in names(analysis_results$pbs_results)) {
    plot_PBS_distribution(analysis_results$pbs_results[[design_name]], 
                          design_name, output_dir)
  }
}
```

## Citation and Acknowledgments
If using this pipeline in published research, please cite:

- **PBS method**: Yi et al. (2010) Sequencing of 50 human exomes reveals adaptation to high altitude. Science 329(5987):75-78.
- **FST calculation**: Weir & Cockerham (1984) Estimating F-statistics for the analysis of population structure. Evolution 38(6):1358-1370.

## Support
For technical issues or questions regarding the pipeline, please:
1. Check the troubleshooting section above
2. Verify input file formats and naming conventions
3. Ensure all required R packages are installed

## Version Information
- **Script Version**: 1.0 (2024)
- **Last Updated**: [Current Date]
- **Compatibility**: PLINK FST output format (v1.9+ recommended)

---
*This pipeline automates PBS analysis for population genomics studies, facilitating the identification of selection signatures across multiple population comparisons.*


# FST Calculation Pipeline

The repository also includes a complementary bash script (`fst_calculation.sh`) designed for pre-processing steps to generate pairwise FST values required for PBS analysis.

#### **Script Overview**
This SLURM-compatible bash script automates the computation of pairwise FST values between populations using VCFtools, along with Tajima's D calculation for target populations. The script prepares the necessary input files for subsequent PBS analysis.

#### **Key Features**
1. **Parallel FST Computation**: Calculates pairwise FST values for all population combinations using sliding windows
2. **Tajima's D Analysis**: Computes Tajima's D statistic for specified target populations
3. **Flexible Population Management**: Supports customizable population lists and sample labeling
4. **Resource Optimization**: Implements parallel processing for efficient computation
5. **Comprehensive Output**: Generates FST matrices suitable for phylogenetic analysis

#### **Input Requirements**
- **VCF File**: Compressed VCF file containing genotype data for all samples
- **Population List**: Text file listing all population names (one per line)
- **Population Labels**: Tab-separated file mapping sample IDs to population labels
- **Software**: VCFtools, BCFtools, GNU Parallel, and Conda environment with required tools

#### **Output Files**
- **FST Window Files**: Pairwise FST values in sliding windows (`*_vs_*.windowed.weir.fst`)
- **Tajima's D Results**: Tajima's D statistics for target populations
- **FST Matrix**: Average FST values between all population pairs (optional)
- **Log Files**: Detailed execution logs and error reports

#### **Usage Instructions**
1. Modify the configuration section with your specific paths and parameters
2. Ensure all input files are properly formatted and accessible
3. Submit the script to a SLURM cluster or execute in a compatible environment
4. Use the generated FST files as input for the PBS analysis script

This pipeline ensures consistent FST calculation methodology and file formatting, guaranteeing compatibility with the downstream PBS analysis workflow.
